{
    "cveId": "CVE-2021-47178",
    "version": "1.0.0",
    "timestamp": "2024-12-06T11:32:07.789868+00:00",
    "description": "In the Linux kernel, the following vulnerability has been resolved scsi target core Avoid smp_processor_id() in preemptible code The BUG message BUG using smp_processor_id() in preemptible [00000000] code was observed for TCMU devices with kernel config DEBUG_PREEMPT. The message was observed when blktests block/005 was run on TCMU devices with fileio backend or userzbc backend [1]. The commit 1130b499b4a7 (scsi target tcm_loop Use LIO wq cmd submission helper) triggered the symptom. The commit modified work queue to handle commands and changed current->nr_cpu_allowed at smp_processor_id() call. The message was also observed at system shutdown when TCMU devices were not cleaned up [2]. The function smp_processor_id() was called in SCSI host work queue for abort handling, and triggered the BUG message. This symptom was observed regardless of the commit 1130b499b4a7 (scsi target tcm_loop Use LIO wq cmd submission helper). To avoid the preemptible code check at smp_processor_id(), get CPU ID with raw_smp_processor_id() instead. The CPU ID is used for performance improvement then thread move to other CPU will not affect the code. [1] [ 56.468103] run blktests block/005 at 2021-05-12 141638 [ 57.369473] check_preemption_disabled 85 callbacks suppressed [ 57.369480] BUG using smp_processor_id() in preemptible [00000000] code fio/1511 [ 57.369506] BUG using smp_processor_id() in preemptible [00000000] code fio/1510 [ 57.369512] BUG using",
    "keyphrases": {
        "rootcause": "Use of smp_processor_id() in preemptible code",
        "weakness": "",
        "impact": "BUG message",
        "vector": "",
        "attacker": "",
        "product": "Linux kernel",
        "version": "",
        "component": "scsi target core"
    }
}
