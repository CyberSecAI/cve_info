{
    "cveId": "CVE-2021-47508",
    "version": "1.0.0",
    "timestamp": "2024-12-19T22:22:49.126128+00:00",
    "description": "In the Linux kernel, the following vulnerability has been resolvedbtrfs free exchange changeset on failuresFstests runs on my VMs have show several kmemleak reports like the following. unreferenced object 0xffff88811ae59080 (size 64) comm xfs_io, pid 12124, jiffies 4294987392 (age 6.368s) hex dump (first 32 bytes) 00 c0 1c 00 00 00 00 00 ff cf 1c 00 00 00 00 00 ................ 90 97 e5 1a 81 88 ff ff 90 97 e5 1a 81 88 ff ff ................ backtrace [] ulist_add_merge+0x60/0x150 [btrfs] [] set_state_bits+0x86/0xc0 [btrfs] [] set_extent_bit+0x270/0x690 [btrfs] [] set_record_extent_bits+0x19/0x20 [btrfs] [] qgroup_reserve_data+0x274/0x310 [btrfs] [] btrfs_check_data_free_space+0x5c/0xa0 [btrfs] [] btrfs_delalloc_reserve_space+0x1b/0xa0 [btrfs] [] btrfs_dio_iomap_begin+0x415/0x970 [btrfs] [] iomap_iter+0x161/0x1e0 [] __iomap_dio_rw+0x1df/0x700 [] iomap_dio_rw+0x5/0x20 [] btrfs_file_write_iter+0x290/0x530 [btrfs] [] new_sync_write+0x106/0x180 [] vfs_write+0x24d/0x2f0 [] __x64_sys_pwrite64+0x69/0xa0 [] do_syscall_64+0x43/0x90In case brtfs_qgroup_reserve_data() or btrfs_delalloc_reserve_metadata()fail the allocated extent_changeset will not be freed.So in btrfs_check_data_free_space() and btrfs_delalloc_reserve_space()free the allocated extent_changeset to get rid of the allocated memory.The issue currently only happens in the direct IO write path, but onlyafter 65b3c08606e5 (btrfs fix ENOSPC failure when attempting direct IOwrite into NOCOW range), and also at defrag_one_locked_target(). Everyother place is always calling extent_changeset_free() even if its callto btrfs_delalloc_reserve_space() or btrfs_check_data_free_space() hasfailed.",
    "keyphrases": {
        "rootcause": "The allocated extent_changeset was not being freed when btrfs_qgroup_reserve_data() or btrfs_delalloc_reserve_metadata() failed.",
        "weakness": "Memory leak due to not freeing allocated memory on error paths.",
        "impact": "Memory leak leading to potential resource exhaustion and system instability.",
        "vector": "Direct I/O write path, specifically after commit 65b3c08606e5, and during defrag_one_locked_target().",
        "attacker": "A malicious actor could trigger this vulnerability by exploiting direct I/O write operations.",
        "product": "Linux Kernel",
        "version": "Affected versions include those with the btrfs filesystem and the mentioned commit 65b3c08606e5.",
        "component": "btrfs filesystem"
    }
}
