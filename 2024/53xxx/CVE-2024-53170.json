{
    "cveId": "CVE-2024-53170",
    "version": "1.0.0",
    "timestamp": "2025-07-04T16:12:41.853043+00:00",
    "description": "In the Linux kernel, the following vulnerability has been resolved block fix uaf for flush rq while iterating tags blk_mq_clear_flush_rq_mapping() is not called during scsi probe, by checking blk_queue_init_done(). However, QUEUE_FLAG_INIT_DONE is cleared in del_gendisk by commit aec89dc5d421 (block keep q_usage_counter in atomic mode after del_gendisk), hence for disk like scsi, following blk_mq_destroy_queue() will not clear flush rq from tags->rqs[] as well, cause following uaf that is found by our syzkaller for v6.6 ================================================================== BUG KASAN slab-use-after-free in blk_mq_find_and_get_req+0x16e/0x1a0 block/blk-mq-tag.c261 Read of size 4 at addr ffff88811c969c20 by task kworker/12H/224909 CPU 1 PID 224909 Comm kworker/12H Not tainted 6.6.0-ga836a5060850 #32 Workqueue kblockd blk_mq_timeout_work Call Trace __dump_stack lib/dump_stack.c88 [inline] dump_stack_lvl+0x91/0xf0 lib/dump_stack.c106 print_address_description.constprop.0+0x66/0x300 mm/kasan/report.c364 print_report+0x3e/0x70 mm/kasan/report.c475 kasan_report+0xb8/0xf0 mm/kasan/report.c588 blk_mq_find_and_get_req+0x16e/0x1a0 block/blk-mq-tag.c261 bt_iter block/blk-mq-tag.c288 [inline] __sbitmap_for_each_set include/linux/sbitmap.h295 [inline] sbitmap_for_each_set include/linux/sbitmap.h316 [inline] bt_for_each+0x455/0x790 block/blk-mq-tag.c325 blk_mq_queue_tag_busy_iter+0x320/0x740 block/blk-mq-tag.c534 blk_mq_timeout_work+0x1a3/0x7b0 block/blk-mq.c1673 process_one_work+0x7c4/0x1450 kernel/workqueue.c2631 process_scheduled_works kernel/workqueue.c2704 [inline] worker_thread+0x804/0xe40 kernel/workqueue.c2785 kthread+0x346/0x450 kernel/kthread.c388 ret_from_fork+0x4d/0x80 arch/x86/kernel/process.c147 ret_from_fork_asm+0x1b/0x30 arch/x86/entry/entry_64.S293 Allocated by task 942 kasan_save_stack+0x22/0x50 mm/kasan/common.c45 kasan_set_track+0x25/0x30 mm/kasan/common.c52 ____kasan_kmalloc mm/kasan/common.c374 [inline] __kasan_kmalloc mm/kasan/common.c383 [inline] __kasan_kmalloc+0xaa/0xb0 mm/kasan/common.c380 kasan_kmalloc include/linux/kasan.h198 [inline] __do_kmalloc_node mm/slab_common.c1007 [inline] __kmalloc_node+0x69/0x170 mm/slab_common.c1014 kmalloc_node include/linux/slab.h620 [inline] kzalloc_node include/linux/slab.h732 [inline] blk_alloc_flush_queue+0x144/0x2f0 block/blk-flush.c499 blk_mq_alloc_hctx+0x601/0x940 block/blk-mq.c3788 blk_mq_alloc_and_init_hctx+0x27f/0x330 block/blk-mq.c4261 blk_mq_realloc_hw_ctxs+0x488/0x5e0 block/blk-mq.c4294 blk_mq_init_allocated_queue+0x188/0x860 block/blk-mq.c4350 blk_mq_init_queue_data block/blk-mq.c4166 [inline] blk_mq_init_queue+0x8d/0x100 block/blk-mq.c4176 scsi_alloc_sdev+0x843/0xd50 drivers/scsi/scsi_scan.c335 scsi_probe_and_add_lun+0x77c/0xde0 drivers/scsi/scsi_scan.c1189 __scsi_scan_target+0x1fc/0x5a0 drivers/scsi/scsi_scan.c1727 scsi_scan_channel drivers/scsi/scsi_scan.c1815 [inline] scsi_scan_channel+0x14b/0x1e0 drivers/scsi/scsi_scan.c1791 scsi_scan_host_selected+0x2fe/0x400 drivers/scsi/scsi_scan.c1844 scsi_scan+0x3a0/0x3f0 drivers/scsi/scsi_sysfs.c151 store_scan+0x2a/0x60 drivers/scsi/scsi_sysfs.c191 dev_attr_store+0x5c/0x90 drivers/base/core.c2388 sysfs_kf_write+0x11c/0x170 fs/sysfs/file.c136 kernfs_fop_write_iter+0x3fc/0x610 fs/kernfs/file.c338 call_write_iter include/linux/fs.h2083 [inline] new_sync_write+0x1b4/0x2d0 fs/read_write.c493 vfs_write+0x76c/0xb00 fs/read_write.c586 ksys_write+0x127/0x250 fs/read_write.c639 do_syscall_x64 arch/x86/entry/common.c51 [inline] do_syscall_64+0x70/0x120 arch/x86/entry/common.c81 entry_SYSCALL_64_after_hwframe+0x78/0xe2 Freed by task 244687 kasan_save_stack+0x22/0x50 mm/kasan/common.c45 kasan_set_track+0x25/0x30 mm/kasan/common.c52 kasan_save_free_info+0x2b/0x50 mm/kasan/generic.c522 ____kasan_slab_free mm/kasan/common.c236 [inline] __kasan_slab_free+0x12a/0x1b0 mm/kasan/common.c244 kasan_slab_free include/linux/kasan.h164 [in ---truncated---",
    "keyphrases": {
        "rootcause": "",
        "weakness": "use-after-free",
        "impact": "",
        "vector": "",
        "attacker": "",
        "product": "Linux kernel",
        "version": "6.6.0-ga836a5060850",
        "component": "block/blk-mq-tag.c261"
    }
}
