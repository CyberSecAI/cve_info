{
    "cveId": "CVE-2024-53095",
    "version": "1.0.0",
    "timestamp": "2024-12-19T22:22:49.126128+00:00",
    "description": "In the Linux kernel, the following vulnerability has been resolved smb client Fix use-after-free of network namespace. Recently, we got a customer report that CIFS triggers oops while reconnecting to a server. [0] The workload runs on Kubernetes, and some pods mount CIFS servers in non-root network namespaces. The problem rarely happened, but it was always while the pod was dying. The root cause is wrong reference counting for network namespace. CIFS uses kernel sockets, which do not hold refcnt of the netns that the socket belongs to. That means CIFS must ensure the socket is always freed before its netns otherwise, use-after-free happens. The repro steps are roughly 1. mount CIFS in a non-root netns 2. drop packets from the netns 3. destroy the netns 4. unmount CIFS We can reproduce the issue quickly with the script [1] below and see the splat [2] if CONFIG_NET_NS_REFCNT_TRACKER is enabled. When the socket is TCP, it is hard to guarantee the netns lifetime without holding refcnt due to async timers. Lets hold netns refcnt for each socket as done for SMC in commit 9744d2bf1976 (smc Fix use-after-free in tcp_write_timer_handler().). Note that we need to move put_net() from cifs_put_tcp_session() to clean_demultiplex_info() otherwise, __sock_create() still could touch a freed netns while cifsd tries to reconnect from cifs_demultiplex_thread(). Also, maybe_get_net() cannot be put just before __sock_create() because the code is not under RCU and there is a small chance that the same address happened to be reallocated to another netns. [0] CIFS VFS \\\\XXXXXXXXXXX has not responded in 15 seconds. Reconnecting... CIFS Serverclose failed 4 times, giving up Unable to handle kernel paging request at virtual address 14de99e461f84a07 Mem abort info ESR = 0x0000000096000004 EC = 0x25 DABT (current EL), IL = 32 bits SET = 0, FnV = 0 EA = 0, S1PTW = 0 FSC = 0x04 level 0 translation fault Data abort info ISV = 0, ISS = 0x00000004 CM = 0, WnR = 0 [14de99e461f84a07] address between user and kernel address ranges Internal error Oops 0000000096000004",
    "keyphrases": {
        "rootcause": "wrong reference counting for network namespace",
        "weakness": "CIFS uses kernel sockets, which do not hold refcnt of the netns that the socket belongs to",
        "impact": "use-after-free leading to kernel panic",
        "vector": "Mount CIFS in a non-root network namespace, drop packets, destroy the namespace, unmount CIFS.",
        "attacker": "unspecified",
        "product": "Linux Kernel",
        "version": "unspecified",
        "component": "CIFS client"
    }
}
