{
    "cveId": "CVE-2024-50217",
    "version": "1.0.0",
    "timestamp": "2024-12-19T22:22:49.126128+00:00",
    "description": "In the Linux kernel, the following vulnerability has been resolved btrfs fix use-after-free of block device file in __btrfs_free_extra_devids() Mounting btrfs from two images (which have the same one fsid and two different dev_uuids) in certain executing order may trigger an UAF for variable device->bdev_file in __btrfs_free_extra_devids(). And following are the details 1. Attach image_1 to loop0, attach image_2 to loop1, and scan btrfs devices by ioctl(BTRFS_IOC_SCAN_DEV) / btrfs_device_1 ? loop0 fs_device \\ btrfs_device_2 ? loop1 2. mount /dev/loop0 /mnt btrfs_open_devices btrfs_device_1->bdev_file = btrfs_get_bdev_and_sb(loop0) btrfs_device_2->bdev_file = btrfs_get_bdev_and_sb(loop1) btrfs_fill_super open_ctree fail btrfs_close_devices // -ENOMEM btrfs_close_bdev(btrfs_device_1) fput(btrfs_device_1->bdev_file) // btrfs_device_1->bdev_file is freed btrfs_close_bdev(btrfs_device_2) fput(btrfs_device_2->bdev_file) 3. mount /dev/loop1 /mnt btrfs_open_devices btrfs_get_bdev_and_sb(&bdev_file) // EIO, btrfs_device_1->bdev_file is not assigned, // which points to a freed memory area btrfs_device_2->bdev_file = btrfs_get_bdev_and_sb(loop1) btrfs_fill_super open_ctree btrfs_free_extra_devids if (btrfs_device_1->bdev_file) fput(btrfs_device_1->bdev_file) // UAF ! Fix it by setting device->bdev_file as NULL after closing the btrfs_device in btrfs_close_one_device().",
    "keyphrases": {
        "rootcause": "Use-after-free vulnerability in `__btrfs_free_extra_devids()`",
        "weakness": "The `device->bdev_file` is not set to NULL after closing the btrfs device in `btrfs_close_one_device()`, leading to a use-after-free when it's accessed later in `__btrfs_free_extra_devids()`",
        "impact": "Use-after-free, potentially leading to crashes or arbitrary code execution.",
        "vector": "Mounting btrfs from two images with the same fsid but different dev_uuids in a specific order",
        "attacker": "A local attacker with the ability to mount file systems",
        "product": "Linux kernel",
        "version": "Affected versions prior to the fix",
        "component": "btrfs"
    }
}
